name: Claude Code Review (Legacy)

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

jobs:
  check-trigger:
    name: Check @claude mention
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for @claude in last commit or PR
        id: check
        run: |
          # For push events, check last commit message
          if [ "${{ github.event_name }}" = "push" ]; then
            LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
            echo "Checking push commit: $LAST_COMMIT_MSG"
            if echo "$LAST_COMMIT_MSG" | grep -qi "@claude"; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # For PR events, check title and body
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="${{ github.event.pull_request.body }}"
            if echo "$PR_TITLE $PR_BODY" | grep -qi "@claude"; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            # Also check last commit of PR
            LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
            if echo "$LAST_COMMIT_MSG" | grep -qi "@claude"; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è No @claude mention found"

  claude-review:
    name: Claude Code Review
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        run: |
          echo "üîç Running Claude code review for changes..."
          git diff HEAD~1 HEAD --name-only | head -10
          echo "‚úÖ Claude review triggered by @claude mention"